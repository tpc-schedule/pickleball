<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>The Pickleball Center – Schedule</title>
<style>
  :root{
    /* Brand */
    --brand-bg:#0f172a; --brand-surface:#1b2436; --brand-text:#e8ecef; --brand-accent:#6cc24a;
    /* Program colors (light) */
    --rental:#ffc2c2;        /* Court Rental - light red */
    --open-play:#fff59d;     /* Open Play - light yellow */
    --clinic:#ffd8a8;        /* Clinic - light orange */
    --tournament:#b7f7c5;    /* Tournament - light green */
    --maintenance:#ffd8a8;   /* Maintenance - light orange */
    --free-trial:#cfe8ff;    /* Free Trial - light blue */
    --na:#d1d5db;            /* Not Available - light gray */
    /* Auto status colors */
    --available:#d1fae5; --available-text:#065f46;
    --not-available:#9ca3af; --not-available-text:#1f2937;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;color:var(--brand-text);background:linear-gradient(180deg,#0b1323,#0f172a 35%,#0b1323)}
  .container{max-width:1100px;margin:28px auto;padding:0 16px}
  .brand{text-align:center;margin-bottom:20px}
  .brand h1{margin:0;font-size:2.4rem;font-weight:800}
  .brand .badge{display:inline-block;margin-top:8px;background:var(--brand-accent);color:#0f172a;font-weight:800;font-size:1.25rem;padding:6px 12px;border-radius:999px}
  .brand img{height:56px;display:block;margin:0 auto 10px auto}
  .card{background:var(--brand-surface);border-radius:14px;box-shadow:0 10px 28px rgba(0,0,0,.35)}
  .card-header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.08)}
  .btn{cursor:pointer;padding:8px 12px;border-radius:10px;font-weight:700;background:#0f1b33;color:var(--brand-text);border:1px solid rgba(255,255,255,.12)}
  .btn:hover{background:#13233f}
  .date-input{background:#0e1a2d;color:var(--brand-text);border:1px solid rgba(255,255,255,.18);border-radius:10px;padding:8px 10px}
  .date-input::-webkit-calendar-picker-indicator{filter:invert(1)}
  .legend{display:flex;flex-direction:column;gap:8px;padding:12px 16px}
  .legend-group{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
  .legend-title{font-weight:800;color:#d2d8de}
  .legend-item{display:flex;gap:8px;align-items:center;font-size:.95rem;white-space:nowrap}
  .swatch{width:14px;height:14px;border-radius:3px}
  .selected-date{padding:0 16px;margin:2px 0 10px;font-size:1.05rem;font-weight:700;text-align:center}
  .venue{padding:0 16px;margin:8px 0 6px;text-align:center;font-weight:600;opacity:.95}
  .reservation{padding:0 16px;margin:4px 0 14px;text-align:center;font-size:.95rem}
  table{width:100%;border-collapse:separate;table-layout:fixed}
  #scheduleTable th, #scheduleTable td{width:33.33%;padding:12px;text-align:center;border:1px solid rgba(255,255,255,.08)}
  thead th{background:rgba(255,255,255,.06);font-weight:800}
  tbody td:first-child{background:rgba(255,255,255,.04);font-weight:700}
  /* Auto status cells */
  .available{background:var(--available)!important;color:var(--available-text)!important;font-weight:700}
  .not-available{background:var(--not-available)!important;color:var(--not-available-text)!important;font-weight:700}
  /* Program-specific colors for occupied cells */
  .event-cell{font-weight:800; color:#0f172a;}
  .event-court-rental{background:var(--rental);}
  .event-open-play{background:var(--open-play);}
  .event-clinic{background:var(--clinic);}
  .event-tournament{background:var(--tournament);}
  .event-maintenance{background:var(--maintenance);}
  .event-free-trial{background:var(--free-trial);}
  .event-not-available{background:var(--na); color:#1f2937;}
</style>
</head>
<body>
  <div class="container">
    <div class="brand">
      <img src="tpc-logo.png" alt="The Pickleball Center logo" onerror="this.style.display='none'">
      <h1>The Pickleball Center</h1>
      <span class="badge">Schedule</span>
    </div>

    <div class="card">
      <div class="card-header">
        <div>
          <button class="btn" id="prevDay">⟵ Prev</button>
          <button class="btn" id="todayBtn">Today</button>
          <button class="btn" id="nextDay">Next ⟶</button>
        </div>
        <input class="date-input" type="date" id="datePicker">
      </div>

      <div class="legend">
        <div class="legend-group">
          <span class="legend-title">Events:</span>
          <div class="legend-item"><span class="swatch" style="background:var(--rental)"></span> Court Rental</div>
          <div class="legend-item"><span class="swatch" style="background:var(--open-play)"></span> Open Play</div>
          <div class="legend-item"><span class="swatch" style="background:var(--clinic)"></span> Clinic</div>
          <div class="legend-item"><span class="swatch" style="background:var(--tournament)"></span> Tournament</div>
          <div class="legend-item"><span class="swatch" style="background:var(--maintenance)"></span> Maintenance</div>
          <div class="legend-item"><span class="swatch" style="background:var(--free-trial)"></span> Free Trial</div>
          <div class="legend-item"><span class="swatch" style="background:var(--na)"></span> Not Available</div>
        </div>
      </div>

      <div class="selected-date" id="selectedDateDisplay"></div>
      <div class="venue" id="venueLine">Venue: WalterMart Sta. Maria</div>
      <div class="reservation">For reservation please contact us on our <a href="https://www.facebook.com/profile.php?id=61578231519925" target="_blank" style="color:var(--brand-accent); text-decoration:none;">Facebook Page</a></div>

      <table id="scheduleTable">
        <thead>
          <tr>
            <th>Time</th>
            <th>Court 1</th>
            <th>Court 2</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<!-- Supabase (read-only) -->
<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

  // Your project (from Settings → API)
  const SUPABASE_URL = 'https://azjzxrvmpptgwvdlnezn.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6anp4cnZtcHB0Z3d2ZGxuZXpuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5ODU3NzUsImV4cCI6MjA3MDU2MTc3NX0.bZXYXyuTjjieHSOpfHgBcwaZa0NX0aROhf9UvfcrJi4';
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const PROGRAM_CLASS = {
    'Court Rental':'event-court-rental',
    'Open Play':'event-open-play',
    'Clinic':'event-clinic',
    'Tournament':'event-tournament',
    'Maintenance':'event-maintenance',
    'Free Trial':'event-free-trial',
    'Not Available':'event-not-available'
  };

  let settings = { blocked_days:[0,1,2,3], court2_default_available:false, venue:'WalterMart Sta. Maria' };
  let currentDate = new Date();

  // Formatting helpers
  const fmtISO = d => { const tz=d.getTimezoneOffset()*60000; return new Date(d.getTime()-tz).toISOString().split('T')[0]; };
  const fmtHour = h => { const h12=(h%12)||12, am=h<12?'AM':'PM'; return (String(h12).padStart(2,'0'))+':00 '+am; };
  const fmtRange = start => `${fmtHour(start)} - ${fmtHour(start+1)}`;
  const fmtFullDate = d => d.toLocaleDateString('en-US',{weekday:'long', year:'numeric', month:'long', day:'numeric'});
  const isBlockedDay = d => (settings.blocked_days||[]).includes(d.getDay());

  async function loadSettings(){
    const { data, error } = await supabase.from('settings').select('*').eq('id',1).maybeSingle();
    if(!error && data){
      settings = data;
      const vEl = document.getElementById('venueLine');
      if(vEl) vEl.textContent = 'Venue: ' + (data.venue || 'WalterMart Sta. Maria');
    }
  }

  async function loadEvents(dateISO){
    // events table: date (date), hour (int), court (int), program (text), title (text)
    const { data, error } = await supabase.from('events')
      .select('hour,court,program,title')
      .eq('date', dateISO)
      .order('hour', { ascending: true });
    if(error){ console.error(error); return []; }
    return data || [];
  }

  function displayHeaderDate(d){
    document.getElementById('datePicker').value = fmtISO(d);
    document.getElementById('selectedDateDisplay').textContent = fmtFullDate(d);
  }

  async function generateSchedule(date){
    const iso = fmtISO(date);
    const dayEvents = await loadEvents(iso);
    const tbody = document.querySelector('#scheduleTable tbody');
    tbody.innerHTML = '';

    for(let start=9; start<=21; start++){
      const tr=document.createElement('tr');

      const timeTd=document.createElement('td');
      timeTd.textContent = fmtRange(start);
      tr.appendChild(timeTd);

      // Court 1
      const td1=document.createElement('td');
      if(isBlockedDay(date)){
        td1.className='not-available'; td1.textContent='Not Available';
      } else {
        const ev1 = dayEvents.find(e => Number(e.court)===1 && Number(e.hour)===start);
        if(ev1){
          td1.className='event-cell ' + (PROGRAM_CLASS[ev1.program] || '');
          td1.textContent = ev1.program==='Not Available'
            ? 'Not Available'
            : (ev1.title ? `${ev1.program} — ${ev1.title}` : ev1.program);
        } else {
          td1.className='available'; td1.textContent='Available';
        }
      }
      tr.appendChild(td1);

      // Court 2
      const td2=document.createElement('td');
      if(isBlockedDay(date)){
        td2.className='not-available'; td2.textContent='Not Available';
      } else {
        const ev2 = dayEvents.find(e => Number(e.court)===2 && Number(e.hour)===start);
        if(ev2){
          td2.className='event-cell ' + (PROGRAM_CLASS[ev2.program] || '');
          td2.textContent = ev2.program==='Not Available'
            ? 'Not Available'
            : (ev2.title ? `${ev2.program} — ${ev2.title}` : ev2.program);
        } else {
          // Court 2 default availability from settings
          if(settings.court2_default_available){
            td2.className='available'; td2.textContent='Available';
          } else {
            td2.className='not-available'; td2.textContent='Not Available';
          }
        }
      }
      tr.appendChild(td2);

      tbody.appendChild(tr);
    }
  }

  // Nav handlers
  document.getElementById('prevDay').addEventListener('click',()=>{ currentDate.setDate(currentDate.getDate()-1); displayHeaderDate(currentDate); generateSchedule(currentDate); });
  document.getElementById('nextDay').addEventListener('click',()=>{ currentDate.setDate(currentDate.getDate()+1); displayHeaderDate(currentDate); generateSchedule(currentDate); });
  document.getElementById('todayBtn').addEventListener('click',()=>{ currentDate=new Date(); displayHeaderDate(currentDate); generateSchedule(currentDate); });
  document.getElementById('datePicker').addEventListener('change',(e)=>{ if(e.target.value){ currentDate = new Date(e.target.value+'T00:00:00'); displayHeaderDate(currentDate); generateSchedule(currentDate);} });

  // Realtime: refresh when events/settings change
  supabase.channel('realtime:events')
    .on('postgres_changes', { event:'*', schema:'public', table:'events' }, () => generateSchedule(currentDate))
    .on('postgres_changes', { event:'*', schema:'public', table:'settings' }, async () => { await loadSettings(); generateSchedule(currentDate); })
    .subscribe();

  // Initial load
  await loadSettings();
  displayHeaderDate(currentDate);
  generateSchedule(currentDate);
</script>
</body>
</html>

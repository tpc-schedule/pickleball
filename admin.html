<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TPC Admin</title>
<style>
  :root{ --bg:#0f172a; --card:#1b2436; --text:#e8ecef; --accent:#6cc24a; }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:var(--text)}
  .wrap{max-width:980px;margin:24px auto;padding:0 16px}
  .card{background:var(--card);padding:16px;border-radius:12px;margin-bottom:16px;border:1px solid rgba(255,255,255,.08)}
  h1{margin:0 0 12px;font-size:22px}
  label{display:block;margin:8px 0 4px}
  input,select,button{font:inherit;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:#0e1a2d;color:var(--text)}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .row > *{flex:1 1 220px}
  .right{display:flex;gap:8px;justify-content:flex-end}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border:1px solid rgba(255,255,255,.12);padding:8px;text-align:left}
  th{background:rgba(255,255,255,.06)}
  .muted{opacity:.85;font-size:.9rem}
  .pill{display:inline-block;background:var(--accent);color:#0f172a;padding:2px 8px;border-radius:999px;font-weight:800}
  .days{display:flex;flex-wrap:wrap;gap:10px}
  .days label{display:flex;align-items:center;gap:6px}
  .auth{display:flex;gap:8px;align-items:end;margin-bottom:8px;flex-wrap:wrap}
  .hide{display:none}
  .note{font-size:.9rem;opacity:.85;margin-top:6px}
  .linkbar{display:flex;gap:12px;margin-bottom:8px}
  .alink{color:var(--accent);text-decoration:none}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="linkbar">
      <a class="alink" href="./index.html">← View public schedule</a>
    </div>
    <h1>Admin • The Pickleball Center <span class="pill">Schedule</span></h1>
    <div class="auth">
      <div>
        <label>Email</label><input id="email" placeholder="you@example.com">
      </div>
      <div>
        <label>Password</label><input id="password" type="password" placeholder="••••••••">
      </div>
      <button id="loginBtn">Sign In</button>
      <button id="logoutBtn" class="hide">Sign Out</button>
      <span id="authState" class="muted"></span>
    </div>
    <p class="muted">Sign in with your admin account to edit settings and events.</p>
  </div>

  <div id="adminBlocks" class="hide">
    <div class="card">
      <h1>Settings</h1>
      <div class="row">
        <div>
          <label for="venue">Venue</label>
          <input id="venue" placeholder="WalterMart Sta. Maria" />
        </div>
        <div>
          <label>Blocked Days</label>
          <div class="days">
            <label><input type="checkbox" class="day" value="0"> Sun</label>
            <label><input type="checkbox" class="day" value="1"> Mon</label>
            <label><input type="checkbox" class="day" value="2"> Tue</label>
            <label><input type="checkbox" class="day" value="3"> Wed</label>
            <label><input type="checkbox" class="day" value="4"> Thu</label>
            <label><input type="checkbox" class="day" value="5"> Fri</label>
            <label><input type="checkbox" class="day" value="6"> Sat</label>
          </div>
        </div>
        <div>
          <label>Court 2 default availability</label>
          <div><input type="checkbox" id="court2Default"> Show Court 2 as Available when there is no event</div>
        </div>
      </div>
      <div class="right" style="margin-top:10px">
        <button id="saveSettings">Save Settings</button>
      </div>
      <p class="note">These settings apply to the public schedule immediately.</p>
    </div>

    <div class="card">
      <h1>Add / Update Event</h1>
      <div class="row">
        <div>
          <label for="date">Date</label>
          <input type="date" id="date" />
        </div>
        <div>
          <label for="time">Start Time (hourly)</label>
          <select id="time"></select>
        </div>
        <div>
          <label for="court">Court</label>
          <select id="court">
            <option value="1">Court 1</option>
            <option value="2">Court 2</option>
          </select>
        </div>
        <div>
          <label for="program">Program</label>
          <select id="program">
            <option>Court Rental</option>
            <option>Open Play</option>
            <option>Clinic</option>
            <option>Tournament</option>
            <option>Maintenance</option>
            <option>Free Trial</option>
            <option>Not Available</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div>
          <label for="title">Optional Title/Notes</label>
          <input id="title" placeholder="e.g., Beginners Group" />
        </div>
        <div class="right" style="align-items:flex-end">
          <button id="saveEvent">Save / Update</button>
          <button id="deleteEvent">Delete This Slot</button>
        </div>
      </div>
      <p class="note">Each (date + hour + court) is one slot. Saving again overwrites that slot.</p>
    </div>

    <div class="card">
      <h1>Events (selected date)</h1>
      <div class="row">
        <div>
          <label for="listDate">Pick Date to View</label>
          <input type="date" id="listDate" />
        </div>
        <div style="align-self:flex-end">
          <button id="refreshList">Refresh</button>
        </div>
      </div>
      <table id="eventsTable">
        <thead><tr><th>Time</th><th>Court</th><th>Program</th><th>Title</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- SUPABASE -->
<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

  // ✅ Your project details
  const SUPABASE_URL = 'https://azjzxrvmpptgwvdlnezn.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6anp4cnZtcHB0Z3d2ZGxuZXpuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5ODU3NzUsImV4cCI6MjA3MDU2MTc3NX0.bZXYXyuTjjieHSOpfHgBcwaZa0NX0aROhf9UvfcrJi4';
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // UI helpers
  const slotStartHour=9, slotEndStartHour=21;
  const $ = id => document.getElementById(id);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const fmtHour = h => { const h12=(h%12)||12, am=h<12?'AM':'PM'; return String(h12).padStart(2,'0')+':00 '+am; };

  // Fill hourly time options
  for(let h=slotStartHour; h<=slotEndStartHour; h++){
    const opt=document.createElement('option');
    opt.value=String(h);
    opt.textContent = fmtHour(h)+' - '+fmtHour(h+1);
    $('time').appendChild(opt);
  }

  // Default dates
  $('date').valueAsDate = new Date();
  $('listDate').valueAsDate = new Date();

  // AUTH
  async function updateAuthUI(session){
    if(session?.user){
      $('authState').textContent = 'Signed in as ' + (session.user.email||'');
      $('loginBtn').classList.add('hide');
      $('logoutBtn').classList.remove('hide');
      $('adminBlocks').classList.remove('hide');
      await initSettings();
      await refreshEventsForSelectedDate();
    }else{
      $('authState').textContent = 'Not signed in';
      $('loginBtn').classList.remove('hide');
      $('logoutBtn').classList.add('hide');
      $('adminBlocks').classList.add('hide');
    }
  }

  $('loginBtn').onclick = async ()=>{
    try{
      const email=$('email').value.trim(), password=$('password').value;
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if(error) throw error;
      updateAuthUI(data.session);
    }catch(err){
      alert(err.message || 'Failed to sign in');
    }
  };

  $('logoutBtn').onclick = async ()=>{
    await supabase.auth.signOut();
    updateAuthUI(null);
  };

  // Restore session on load
  const { data: { session } } = await supabase.auth.getSession();
  updateAuthUI(session);
  supabase.auth.onAuthStateChange((_event, sess)=> updateAuthUI(sess));

  // SETTINGS
  async function initSettings(){
    const { data, error } = await supabase.from('settings').select('*').eq('id',1).maybeSingle();
    if(error){ console.warn('Load settings error', error); return; }
    const s = data || { venue:'WalterMart Sta. Maria', blocked_days:[0,1,2,3], court2_default_available:false };
    $('venue').value = s.venue || '';
    const set = new Set(s.blocked_days || []);
    $$('.day').forEach(cb => cb.checked = set.has(Number(cb.value)));
    $('court2Default').checked = !!s.court2_default_available;
  }

  $('saveSettings').onclick = async ()=>{
    try{
      const blocked = $$('.day').filter(cb=>cb.checked).map(cb=>Number(cb.value));
      const venue = $('venue').value.trim() || 'WalterMart Sta. Maria';
      const court2Default = $('court2Default').checked;
      const { error } = await supabase.from('settings').upsert({ id:1, venue, blocked_days:blocked, court2_default_available:court2Default });
      if(error) throw error;
      alert('Settings saved.');
    }catch(err){
      alert(err.message || 'Failed to save settings');
    }
  };

  // EVENTS (selected date list)
  async function refreshEventsForSelectedDate(){
    const dateISO = $('listDate').value || $('date').value;
    if(!dateISO) return;
    const { data, error } = await supabase.from('events').select('*').eq('date', dateISO).order('hour');
    const tbody = $('eventsTable').querySelector('tbody'); tbody.innerHTML='';
    if(error){ tbody.innerHTML='<tr><td colspan="4">Error loading</td></tr>'; return; }
    (data||[]).forEach(e=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${fmtHour(e.hour)} - ${fmtHour(e.hour+1)}</td><td>${e.court}</td><td>${e.program}</td><td>${e.title||''}</td>`;
      tbody.appendChild(tr);
    });
  }
  $('refreshList').onclick = refreshEventsForSelectedDate;
  $('listDate').addEventListener('change', refreshEventsForSelectedDate);

  // SAVE / DELETE EVENT
  $('saveEvent').onclick = async ()=>{
    try{
      const date = $('date').value;
      const hour = Number($('time').value);
      const court = Number($('court').value);
      const program = $('program').value;
      const title = $('title').value.trim();
      if(!date || Number.isNaN(hour)){ alert('Please pick date and time.'); return; }
      const { error } = await supabase.from('events').upsert({ date, hour, court, program, title });
      if(error) throw error;
      await refreshEventsForSelectedDate();
      alert('Saved.');
    }catch(err){
      alert(err.message || 'Failed to save');
    }
  };

  $('deleteEvent').onclick = async ()=>{
    try{
      const date = $('date').value;
      const hour = Number($('time').value);
      const court = Number($('court').value);
      if(!date || Number.isNaN(hour)){ alert('Pick date and time to delete.'); return; }
      const { error } = await supabase.from('events').delete()
        .eq('date',date).eq('hour',hour).eq('court',court);
      if(error) throw error;
      await refreshEventsForSelectedDate();
      alert('Deleted (if existed).');
    }catch(err){
      alert(err.message || 'Failed to delete');
    }
  };
</script>
</body>
</html>
